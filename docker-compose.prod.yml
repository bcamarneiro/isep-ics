services:
  isep-ics:
    build: .
    container_name: isep-ics
    environment:
      # Non-sensitive configuration
      ISEP_BASE_URL: "https://portal.isep.ipp.pt"
      ISEP_ENTIDADE: "aluno"
      ISEP_FETCH_WEEKS_BEFORE: "0"
      ISEP_FETCH_WEEKS_AFTER: "6"
      ISEP_REFRESH_MINUTES: "15"
      TZ: "Europe/Lisbon"
      PORT: "8080"
      # Sensitive data from Docker secrets
      ISEP_USERNAME_FILE: "/run/secrets/isep_username"
      ISEP_PASSWORD_FILE: "/run/secrets/isep_password"
      ISEP_CODE_USER_FILE: "/run/secrets/isep_code_user"
      ISEP_CODE_USER_CODE_FILE: "/run/secrets/isep_code_user_code"
    secrets:
      - isep_username
      - isep_password
      - isep_code_user
      - isep_code_user_code
    ports:
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bun", "--bun", "run", "-e", "fetch('http://localhost:8080/healthz').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

secrets:
  isep_username:
    file: ./secrets/isep_username.txt
  isep_password:
    file: ./secrets/isep_password.txt
  isep_code_user:
    file: ./secrets/isep_code_user.txt
  isep_code_user_code:
    file: ./secrets/isep_code_user_code.txt
